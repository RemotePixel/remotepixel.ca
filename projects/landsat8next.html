<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Date and weather condition of Next Landsat image">
	<meta name="author" content="Vincent Sarago">
    <meta name="twitter:title" content="Landsat 8 Next" />
    <meta name="twitter:site" content="@RemotePixel" />
    <meta name="twitter:description" content="Date and weather condition of Next Landsat 8 image" />

	<title>Remote Pixel | Landsat 8 Next</title>

    <!-- leaflet CSS -->
    <link href="/css/leaflet.css" rel="stylesheet">

	<!-- Bootstrap Core CSS -->
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="/css/rpix_general.css" rel="stylesheet">
    <link href="/css/rpix_landsatnext.css" rel="stylesheet">
	<!-- <link href="/css/Control.MiniMap.min.css" rel="stylesheet"> -->

	<!-- Custom Fonts -->
	<link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="../weather-icons/css/weather-icons.min.css" rel="stylesheet">

	<link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
	        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	    <![endif]-->

 	<script>
   	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
   	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
   	  ga('create', 'UA-60678866-1', 'auto');
   	  ga('send', 'pageview');
	</script>

</head>

<body data-target=".navbar-fixed-top">
    <!-- Navigation -->
	<nav class="navbar navbar-custom navbar-fixed-top top-nav-collapse" role="navigation">
		<div class="container">
			<div class="navbar-header">
			    <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target=".navbar-main-collapse">
                    <i class="fa fa-bars" style="color: #fff"></i></button>

				<a class="navbar-brand page-scroll" href="/projects/index.html#L8nxt">
				    <i class="fa fa-play-circle"></i>
				    <span class="light">back to Projects</span>
			    </a>
			</div>
			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse navbar-right navbar-main-collapse">
				<ul class="nav navbar-nav">
					<!-- Hidden li included to remove active class from about link when scrolled up past about section -->
                    <li class="hidden"><a href="#page-top"></a></li>
                    <li><a class="glyphicon glyphicon-home" href="/"></a></li>
                    <li><a href="/projects/index.html">projects</a></li>
                    <li><a href="/blog/index.html">Blog</a></li>
                    <li><a href="/contact.html">Contact</a></li>
				</ul>
			</div>
		</div>
		<!-- /.container -->
	</nav>

	<div class="content">
        <div class="col-md-4 col-xs-4 col-lg-4 sidebar left" id="left-pane">
            <div id="landsat-wall" class="landsat-wall"></div>
        </div>

        <div id="map" class="map">
            <img class="centerIcon" src="/img/marker-icon.png" style="display: inline;">
        </div>
	</div>

   <!-- Modal -->
    <div  id="modalShare" class="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="sharezone">
            <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times-circle"></i></button>
            <a id="twitter" class="sharebutt" href="" title="Share on Twitter" target="_blank">
                <i class="fa fa-twitter"></i>
            </a>
            <a id="linkedin" class="sharebutt" href="" title="Share on LinkedIn" target="_blank">
                <i class="fa fa-linkedin"></i>
            </a>
            <a id="facebook" class="sharebutt" href="" title="Share on Facebook" target="_blank">
                <i class="fa fa-facebook"></i>
            </a>
        </div>
    </div>
    <!-- /.modal -->

    <!-- Modal -->
    <div class="modal fade" id="modalAbout" tabindex="-1" role="dialog"
        aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">&times;</button>
                    <h4 class="modal-title" style="text-align:center; color:#000;">Landsat 8 Next</h4>
                </div>
                   <div class="modal-body">
                        <div class="hmodal-info">
	                        <p>Landsat 8 Next is a tool for finding when will be the next landsat acquisition over a location</p>

		                    <ol class="deci">
	                            <li>Dragg the THE MAP <img src="/img/marker-icon-2x.png" style="height:16px"> to an area of interest</li>
                                <li>See path/row combinations covering the point of interest on the left</li>
			                </ol>

		                    <p>Search results are powered by <a href="https://api.remotepixel.ca/landsat" target="_blank">RemotePixel Landsat API</a>
                            and wrs 2 tiles from <a href="https://api.remotepixel.ca/wrs2tiles" target="_blank">wrs2tiles API.</p>

                            <p>Images from <a href="http://earthexplorer.usgs.gov" target="_blank">USGS Earth Explorer</a>.</p>

                            <p>Weather results are powered by <a href="http://openweathermap.org/api" target="_blank">OpenWeatherMap API</a>.

		                    <p>Questions or comments to <a href="mailto:vincent.sarago@gmail.com">vincent.sarago@gmail.com</a></p>

                        </div>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <!-- jQuery -->
    <script src="/js/jquery.js"></script>
    <script src="/js/jquery.easing.min.js"></script>

    <script src="/js/moment.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/spin.min.js"></script>

    <script src="/js/leaflet.js"></script>
    <script src="/js/leaflet.spin.js"></script>
    <script src="/js/easy-button.js"></script>
    <script src="/js/leaflet.textpath.js"></script>

    <script src="/js/turf.min.js"></script>

    <script>

        //From Libra by developmentseed (https://github.com/developmentseed/libra)
        function mod(number, dividend) {
            return ((number % dividend) + dividend) % dividend;
        };

        function resetmap(){
            footprintGr.clearLayers();
            scope.center = undefined;
       };

        function cleanmap(){
            footprintGr.clearLayers();
            $('#landsat-wall').empty();
            $('#landsat-wall').scrollTop(0);
        };

        function sortScenes(a, b){
            return Date.parse(b.acquisitionDate) - Date.parse(a.acquisitionDate);
        };

		function getDataAndUpdate(adress) {

			map.spin(true);

			cleanmap();

            var adjust = Math.floor((map.getCenter().lng + 180) / 360) * 360;

            var tiles = [];
        	$.getJSON(adress, function(data) {

			    for (var i=0; i < data.results.length; i++){
                    var tile = {};
                    tile.geometry = data.results[i].geometry;
                    tile.path = data.results[i].path;
                    tile.row = data.results[i].row;
                    tiles.push(tile)
				};

	            var defaultStyle = {
	                    color: "#000",
	                    weight: 2.,
	                    fill: true,
	                    fillOpacity: 0,
	                    opacity: 1
	            };

	            var highlightStyle = {
	                    color: '#2262CC',
	                    weight: 3,
	                    opacity: 0.6,
	                    fill: true,
	                    fillOpacity: 0.65,
	                    fillColor: '#2262CC'
	            };

 	            for (var i=0; i < tiles.length; i++){

 	            	var poly = turf.polygon([tiles[i].geometry.coordinates[0]]);
                    var coords = turf.flip(poly).geometry.coordinates[0]

                    var poly = L.polygon(coords, defaultStyle, {clickable: false});
 	                poly.row = tiles[i].row;
                    poly.path = tiles[i].path;

                    poly.setText(poly.path + '-' + poly.row, {offset: -5, 'font-size': 24})

					footprintGr.addLayer(poly);
                    populate_rp(poly.path, poly.row)
 	            };

	            map.spin(false);
			}).fail(function() {
				map.spin(false);
  			});
        };


        function getWeather(lat, lon, d){
        	var url = "http://api.openweathermap.org/data/2.5/forecast/daily?lat="+ lat.toString() +"&lon="+ lon.toString() + "&cnt=16&APPID=177ccd38a6f427958410e8a801a19055";

        	var weather = {};
        	$.getJSON(url, function(data) {
        		weather['list'] = data.list;
        	}).fail(function() {
                console.log("Erreur openweathermap-api")
                return '';
            });

            for (var i=0; i < weather.list.length; i++){
                var wd = {};
                wd.date = moment.unix(weather.list[i].dt).format('YYYY-MM-DD');
                wd.icon = weatherIcons(weather.list[i].weather["0"].main);
                if (wd.date == d) {
                    return wd.icon;
                }
            };
        }

        function weatherIcons(weath){
        	switch(weath) {
	            case 'Rain':
	            	return '<i class="wi wi-rain"></i>';

	            case 'Clear':
	                return '<i class="wi wi-day-sunny"></i>';

                case 'Clouds':
                    return '<i class="wi wi-cloudy"></i>';

                default:
	            	return '';
	        }
        }

        function populate_rp(path, row){
        	$.ajaxSetup({async: false});
            var datefilter = "acquisitionDate:[" + scope.datestart + "+TO+" + scope.dateend + "]";
                rpfilter = "+AND+path:" + path.toString() + "+AND+row:" + row.toString(),
                query = scope.api_landsat + datefilter + rpfilter + "&limit=2";

            var results = [];

            $.getJSON(query, function(data) {
                var total = data.info.results.total;
                for (var i=0; i < data.results.length; i++){
                    var scene = {};
                    scene.rowpath = data.results[i].row + '-' + data.results[i].path;
                    scene.className = data.results[i].sceneID + '-' + data.results[i].row + '-' + data.results[i].path;
                    scene.acquisitionDate = data.results[i].acquisitionDate;
                    scene.browseAvailable = data.results[i].browseAvailable;
                    scene.browseURL = data.results[i].browseURL;
                    scene.cloudCover = data.results[i].cloudCover;
                    scene.cloudCoverFull = data.results[i].cloudCoverFull;
                    scene.path = data.results[i].path;
                    scene.row = data.results[i].row;
                    scene.sunAzimuth = data.results[i].sunAzimuth;
                    scene.sunElevation = data.results[i].sunElevation;
                    scene.sceneID = data.results[i].sceneID;

                    if (scene.browseAvailable !== "Y") scene.browseURL = "";

                    results.push(scene);
                };

                results.sort(sortScenes);

                var latest = results[0];
                var nextDate =  moment(latest.acquisitionDate, "YYYY-MM-DD").add(16, 'days').format('YYYY-MM-DD');
                var weatherIcon = getWeather(scope.center.lat, scope.center.lng, nextDate);

                $('#landsat-wall').append(
                    // '<div id ="img_' +  latest.sceneID + '" class="result-content" onclick=showRPModal('+ path +','+ row+')>'+
					'<div id ="img_' +  latest.sceneID + '" class="result-content">'+
                        '<img id="' + latest.sceneID +  '" ' +
                            'class="img-thumb"' +
                            'src="' + latest.browseURL + '">'+

                        // '<div class="result-hover">'+
                        //     '<div class="result-hover-content">'+
                        //         '<i class="fa fa-plus fa-3x"></i>'+
                        //     '</div>'+
                        // '</div>'+

                        '<div class="result-overlay">' +
                            '<div><span> Path/Row: ' +  path + ' / ' + row  + '</span></div>' +
                            '<div><span>' + latest.sceneID + '</span></div>' +
	                        '<div><i class="fa fa-calendar-o"></i><span> ' + latest.acquisitionDate + '</span></div>' +
                            '<div><span> Next Acquisition: ' +  nextDate  + ' (' + weatherIcon + ')</span></div>' +
                        '</div>' +
                    '</div>'
                );

            }).fail(function() {
                console.log("Erreur Landsat-api")
            });
            $.ajaxSetup({async: true});
        };

        // function showRPModal(path, row){
        //     $("#ba-link").attr('href', 'landsat8ba_pathrow.php?path=' + path + '&row=' + row)
        //     $("#evol-link").attr('href', 'landsat8evol_pathrow.php?path=' + path + '&row=' + row)
		//
        //     $('#rpixModal').modal();
        // };

        function updateMap(LatLng){

            if (typeof LatLng === 'undefined') {
                return;
            };

            var lat = "lat:" + (LatLng.lat).toString(),
                lon = "+AND+lon:" + (mod(LatLng.lng + 180, 360) - 180).toString(),
                query = scope.api_wrs2 + lat + lon;

            getDataAndUpdate(query);
        };

        ////////////////////////////////////////////////////////////////////////
        //Global Variables

        var scope = {
                center: undefined,
                api_wrs2: 'https://api.remotepixel.ca/wrs2tiles?search=',
                api_landsat: 'https://api.remotepixel.ca/landsat?search=',
                datestart: moment().subtract(25, 'days').format('YYYY-MM-DD'),
                dateend: moment().utc().format('YYYY-MM-DD')
        };

        var map = L.map('map', {
            center: [0, 0],
            bounceAtZoomLimits: false,
            worldCopyJump: false,
			zoomControl: false,
			touchZoom: false,
			inertia: false,
            doubleClickZoom: 'center',
            scrollWheelZoom: 'center',
            minZoom: 4,
            zoom: 4,
            maxZoom: 11
        });

        var osm_url = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';
        var OpenStreetMap = L.tileLayer(osm_url, {id: 'MapID', attribution: attribution})
                .addTo(map);

		var mapLink ='<a href="https://www.esri.com/">Esri</a>';
        var wholink = 'i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';
        var esriWorld = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; '+mapLink+', '+wholink,
            maxZoom: 18});

		var baseMaps = {
		    "OpenStreetMap": OpenStreetMap,
            "ESRI-Satellite" : esriWorld
		};

        L.control.zoom({position:'topright'}).addTo(map);
        L.control.layers(baseMaps, '', {position:'bottomright'}).addTo(map);

        var footprintGr = new L.featureGroup().addTo(map);

        map.on('dragend', function (e){
            scope.center = map.getCenter();
            updateMap(map.getCenter())
        });

        L.easyButton('fa-home',
            function (){
                resetmap();
                map.fitWorld();
            },
            'Reset');

        L.easyButton('fa-share',
                function (){

                    $("#twitter").attr('href','https://twitter.com/share?text=Date and weather condition of Next Landsat 8 image&url=' + window.location.href + '&via=RemotePixel&hashtags=Landsat&related=NASA_Landsat');
                    $("#linkedin").attr('href','https://www.linkedin.com/shareArticle?mini=true&url=' + window.location.href + '&title='+ document.title + '&source=https://remotepixel.ca');
                    $("#facebook").attr('href','https://www.facebook.com/sharer/sharer.php?u=' + window.location.href);

                    $('#modalShare').modal();
                },
                'Share it');

        L.easyButton('fa-info',
            function (){
        	   $('#modalAbout').modal();
            },
            'About');

        $( document ).ready(function() {
        	//$('#modalAbout').modal();
        });

    </script>
</body>
</html>
