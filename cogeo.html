<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />

    <title>cogeo.remotepixel.ca</title>

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />

    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
  </head>
  <body>

    <div id='map'></div>
    <script>

      const endpoint = 'https://cogeo.remotepixel.ca';
      mapboxgl.accessToken = '{MAPBOX TOKEN}';

      const parseParams = (w_loc) => {
        const param_list = w_loc.replace('?', '').split('&')
        const out_params = {}
        for (let i = 0; i < param_list.length; i++) {
          let tPar = param_list[i].split('=');
          out_params[tPar[0]] = tPar[1]
        }
        return out_params;
      };

      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/basic-v9',
          center: [-119.5591, 37.715],
          zoom: 9,
          hash: true
      });

      const addAOI = (bounds) => {
        const geojson = {
            "type": "FeatureCollection",
            "features": [turf.bboxPolygon(bounds)]
        }

        map.addSource('aoi', {
          'type': 'geojson',
          'data': geojson
        })

        map.addLayer({
          id: 'aoi-polygon',
          type: 'line',
          source: 'aoi',
          layout: {
            'line-cap': 'round',
            'line-join': 'round'
          },
          paint: {
            'line-color': '#3bb2d0',
            'line-width': 1
          }
        })
        return
      }

      map.on('load', () => {
        const params = parseParams(window.location.search)
        if (params.url) {
            const bounds_query = `${endpoint}/bounds?url=${params.url}`;
            $.getJSON(bounds_query).done()
              .then(data => {

                const bounds = data.bounds
                map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]])
                addAOI(bounds)

                const urlParams = Object.keys(params).map(i => `${i}=${params[i]}`).join('&')
                map.addSource('tiles', {
                    "type": "raster",
                    "tiles": [`${endpoint}/tiles/{z}/{x}/{y}.png?${urlParams}`],
                    "tileSize": 256,
                    "bounds": bounds
                });
                map.addLayer({"id": "tiles", "source": "tiles", "type": "raster"});
            });
          }
      });
    </script>

  </body>
</html>
