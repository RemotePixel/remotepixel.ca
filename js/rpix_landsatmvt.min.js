var scope={results:{},cloudmin:0,cloudmax:100,datestart:moment("2013-04-01").utc(),dateend:moment.utc()};$("#modalPreview").on("shown.bs.modal",function(){$(".img-preview").focus()});$("#modalPreview").on("hidden.bs.modal",function(){$(".img-preview").scrollTop(0);$(".img-preview").empty()});$("#modalDownloadL8").on("shown.bs.modal",function(){$("#modalDownloadL8 .dwn-bands").focus()});$("#modalDownloadL8").on("hidden.bs.modal",function(){$("#modalPreview").focus();$("#modalDownloadL8 .dwn-bands").empty();$("#modalDownloadL8 .overview").attr("data-id","");$("#modalDownloadL8 .overview").html('<span><i class="fa fa-spinner fa-spin"></i></span>');$("#modalDownloadL8 .dropdown-menu li a").each(function(a,b){$(b).removeClass("on")});$("#modalDownloadL8 .dropdown-menu li a").first().addClass("on");$("#modalDownloadL8 .dropdown .btn:first-child").html($("#modalDownloadL8 .dropdown-menu li a").first().text()+' <span class="caret"></span>')});$(function(){$("#modalDownloadL8 .dropdown-menu li a").click(function(){$("#modalDownloadL8 .overview").html('<span><i class="fa fa-spinner fa-spin"></i></span>');$("#modalDownloadL8 .dropdown .btn:first-child").html($(this).text()+' <span class="caret"></span>');var a={scene:$("#modalDownloadL8 .overview").attr("data-id"),bands:$(this).parent().attr("data-bands")};$.post("{{ RPIX_API }}/landsat/overview",JSON.stringify({info:a})).done(function(b){if(!(b.hasOwnProperty("errorMessage"))){$("#modalDownloadL8 .overview").html('<img src="data:image/png;base64,'+b.data+'">')}else{$("#modalDownloadL8 .overview").html("<span>Preview Unavailable</span>")}}).fail(function(){$("#modalDownloadL8 .overview").html("<span>Preview Unavailable</span>")});$("#modalDownloadL8 .dropdown-menu li a").each(function(b,c){$(c).removeClass("on")});$(this).addClass("on")})});if(!mapboxgl.supported()){alert("Your browser does not support Mapbox GL");$("#modalGL").modal()}else{mapboxgl.accessToken="{MAPBOX TOKEN}";var map=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/light-v9",center:[-70.5,40],zoom:4,attributionControl:false,minZoom:4,maxZoom:7});map.addControl(new mapboxgl.Navigation({position:"top-left"}));var ctrl=document.getElementsByClassName("mapboxgl-ctrl-bottom-right")[0],attr=document.createElement("div");attr.className="mapboxgl-ctrl-attrib mapboxgl-ctrl";ctrl.appendChild(attr);$(".mapboxgl-ctrl-attrib").append('<a href="https://remotepixel.ca" target="_blank">&copy; RemotePixel.ca</a>');$(".mapboxgl-ctrl-attrib").append('<a href="https://www.mapbox.com/about/maps/" target="_blank"> © Mapbox</a>');$(".mapboxgl-ctrl-attrib").append('<a href="http://www.openstreetmap.org/about/" target="_blank"> © OpenStreetMap</a>');map.on("mousemove",function(b){var a=map.queryRenderedFeatures(b.point,{layers:["grdL8"]}),c;if(a.length!==0){c=["any"];a.forEach(function(d){c.push(["all",["==","PATH",d.properties.PATH],["==","ROW",d.properties.ROW]])});map.setFilter("grdL8-highlighted",c)}});map.on("click",function(b){scope.results={};$(".spin").removeClass("display-none");var a=map.queryRenderedFeatures(b.point,{layers:["grdL8"]}),c;if(a.length!==0){c=["any"];a.forEach(function(d){c.push(["all",["==","PATH",d.properties.PATH],["==","ROW",d.properties.ROW]])});map.setFilter("grdL8-selected",c);buildQueryAndRequestL8(a)}else{$(".spin").addClass("display-none");map.setFilter("grdL8-selected",["in","PATH",""])}});map.on("style.load",function(){map.addSource("landsat",{type:"vector",url:"mapbox://vincentsarago.9vmfvfcx"});map.addLayer({id:"grdL8",type:"fill",source:"landsat","source-layer":"LANDSAT_8_metageojson",paint:{"fill-outline-color":"#324952","fill-color":"#0f6d8e","fill-opacity":0.1}});map.addLayer({id:"grdL8-highlighted",type:"fill",source:"landsat","source-layer":"LANDSAT_8_metageojson",paint:{"fill-outline-color":"#324952","fill-color":"#0f6d8e","fill-opacity":0.4},filter:["in","PATH",""]});map.addLayer({id:"grdL8-selected",type:"fill",source:"landsat","source-layer":"LANDSAT_8_metageojson",paint:{"fill-outline-color":"#324952","fill-color":"#0f6d8e","fill-opacity":0.4},filter:["in","PATH",""]});$(".loading-map").addClass("off")})}function hoverPR(a){map.setFilter("grdL8-highlighted",a)}function zeroPad(d,b){var a=String(d);if(a.length<b){return zeroPad("0"+d,b)}return a}function sortScenes(d,c){return Date.parse(c.date)-Date.parse(d.date)}function buildQueryAndRequestL8(f){$(".list-img").scrollTop(0);$(".list-img").empty();var e={};f.forEach(function(o){var q=JSON.parse(o.properties.cloudCover),p=JSON.parse(o.properties.acquisitionDate),l,k,n,m=[],h=[];for(k=0;k<p.length;k+=1){if(q[k]<=scope.cloudmax){if(scope.datestart<=moment(p[k])&&moment(p[k])<=scope.dateend){m.push(p[k]);h.push(q[k])}}}for(l=0;l<m.length;l+=1){n={};n.path=o.properties.PATH.toString();n.row=o.properties.ROW.toString();n.grid=n.path+"/"+n.row;n.date=m[l];n.cloud=h[l];n.sceneID="LC8"+zeroPad(n.path,3)+zeroPad(n.row,3)+n.date.slice(0,4)+zeroPad(moment(n.date).utc().dayOfYear().toString(),3)+"LGN00";n.browseURL="http://earthexplorer.usgs.gov/browse/landsat_8/"+n.date.slice(0,4)+"/"+zeroPad(n.path,3)+"/"+zeroPad(n.row,3)+"/"+n.sceneID+".jpg";n.usgsURL="http://earthexplorer.usgs.gov/order/process?dataset_name=LANDSAT_8&ordered="+n.sceneID;n.AWSurl="http://landsat-pds.s3.amazonaws.com/L8/"+zeroPad(n.path,3)+"/"+zeroPad(n.row,3)+"/"+n.sceneID+"/";if(e.hasOwnProperty(n.grid)){e[n.grid].push(n)}else{e[n.grid]=[];e[n.grid].push(n)}}});var d=Object.keys(e),c,b,a,g;for(c=0;c<d.length;c+=1){e[d[c]].sort(sortScenes);b=e[d[c]][0];a="['all', ['==', 'PATH', "+b.path+"], ['==', 'ROW', "+b.row+"]]";g="['all', ['==', 'PATH', ''], ['==', 'ROW', '']]";$(".list-img").append('<div id ="'+b.grid+'" onclick="feedPreviewL8(this)" onmouseover="hoverPR('+a+')" onmouseout="hoverPR('+g+')" class="list-element"><div class="col"><div class="prinfo"><span class="pathrow">'+b.grid+'</span></div><div class="prinfo"><span class="date">Latest: '+b.date+'  </span><span class="date"><i class="fa fa-cloud"></i> '+b.cloud+'%</span></div></div><div class="img-thumb"><img id="'+b.sceneID+'" class="img-item img-responsive lazy2 lazyload"src="'+b.browseURL+'"></div></div>')}scope.results=e;$(".spin").addClass("display-none")}function feedPreviewL8(c){var b=scope.results[c.id],a;for(a=0;a<b.length;a+=1){$(".img-preview").append('<div class="item"><img class="img-item img-responsive lazy lazyload" data-src="'+b[a].browseURL+'" class="img-responsive"><div class="result-overlay"><span>'+b[a].sceneID+'</span><span><i class="fa fa-calendar-o"></i> '+b[a].date+'</span><span><i class="fa fa-cloud"></i> '+b[a].cloud+'%</span><span>Link:</span><div class="btnDD" onclick="feeddownloadL8(\''+b[a].AWSurl+"','"+b[a].sceneID+'\')"><i class="fa fa-download"></i></div><a target="_blank" href="'+b[a].AWSurl+'index.html"><img src="/img/aws.png"> </a><a target="_blank" href="'+b[a].usgsURL+'"><img src="/img/usgs.jpg"></a></div></div>')}$("#modalPreview").modal()}function feeddownloadL8(a,c){$("#modalDownloadL8 .overview").attr("data-id",c);$("#modalDownloadL8 .dwn-bands").append('<span>Direct Download L8 band (Right Click on link)</span><a id="b1" target="_blank" href="'+a+c+'_B1.TIF" download>B1 - Coastal aerosol</a><a id="b2" target="_blank" href="'+a+c+'_B2.TIF" download>B2 - Blue</a><a id="b3" target="_blank" href="'+a+c+'_B3.TIF" download>B3 - Green</a><a id="b4" target="_blank" href="'+a+c+'_B4.TIF" download>B4 - Red</a><a id="b5" target="_blank" href="'+a+c+'_B5.TIF" download>B5 - Near Infrared</a><a id="b6" target="_blank" href="'+a+c+'_B6.TIF" download>B6 - Shortwave Infrared 1</a><a id="b7" target="_blank" href="'+a+c+'_B7.TIF" download>B7 - Shortwave Infrared 2</a><a id="b8" target="_blank" href="'+a+c+'_B8.TIF" download>B8 - Panchromatic (15m)</a><a id="b9" target="_blank" href="'+a+c+'_B9.TIF" download>B9 - Cirrus</a><a id="b10" target="_blank" href="'+a+c+'_B10.TIF" download>B10 - Thermal Infrared 1</a><a id="b11" target="_blank" href="'+a+c+'_B11.TIF" download>B11 - Thermal Infrared 2</a><a id="bQA" target="_blank" href="'+a+c+'_BQA.TIF" download>BQA - Quality Assessment</a><a id="mtl" target="_blank" href="'+a+c+'_MTL.txt" download>MTL - Metadata</a>');var b={scene:c,bands:"[4,3,2]"};$.post("{{ RPIX_API }}/landsat/overview",JSON.stringify({info:b})).done(function(d){if(!(d.hasOwnProperty("errorMessage"))){$("#modalDownloadL8 .overview").html('<img src="data:image/png;base64,'+d.data+'">')}else{$("#modalDownloadL8 .overview").html("<span>Preview Unavailable</span>")}}).fail(function(){$("#modalDownloadL8 .overview").html("<span>Preview Unavailable</span>")});$("#modalDownloadL8").modal()}function filterL8Grid(){map.setFilter("grdL8-selected",["in","PATH",""]);$(".list-img").scrollTop(0);$(".list-img").empty();$(".list-img").append('<span class="nodata-error">Click on Tile</span>');if($(".button-update").attr("disabled")!==""){$(".button-update").attr("disabled",false)}var a=map.querySourceFeatures("landsat",{sourceLayer:"LANDSAT_8_metageojson",filter:null}),b;if(a.length!==0){b=["any"];a.forEach(function(g){if("PATH" in g.properties){var d=JSON.parse(g.properties.cloudCover),f=JSON.parse(g.properties.acquisitionDate),h=d.map(function(e){return e<=scope.cloudmax}),c=f.filter(function(j,i,e){if(h[i]===true){return(scope.datestart<=moment(j)&&moment(j)<=scope.dateend)}return false});if(c.length!==0){b.push(["all",["==","PATH",g.properties.PATH],["==","ROW",g.properties.ROW]])}}});map.setFilter("grdL8",b)}}function setDate(){scope.datestart=moment.unix($("#dateSlider").val()[0]);scope.dateend=moment.unix($("#dateSlider").val()[1]);$(".dateValues").html(scope.datestart.format("MMM DD, YYYY")+" - "+scope.dateend.format("MMM DD, YYYY"))}function updateDate(){scope.datestart=moment.unix($("#dateSlider").val()[0]);scope.dateend=moment.unix($("#dateSlider").val()[1]);$(".dateValues").html(scope.datestart.format("MMM DD, YYYY")+" - "+scope.dateend.format("MMM DD, YYYY"));filterL8Grid()}function setCloud(){scope.cloudmax=parseInt($("#cloudCoverSlider").val());$(".cloudValues").html('<i class="fa fa-cloud"></i> '+scope.cloudmin+" - "+scope.cloudmax+" %")}function updateCloud(){scope.cloudmax=parseInt($("#cloudCoverSlider").val());$(".cloudValues").html('<i class="fa fa-cloud"></i> '+scope.cloudmin+" - "+scope.cloudmax+" %");if(scope.cloudmax===0){scope.cloudmax=1}filterL8Grid()}function initFilters(){$("#cloudCoverSlider").noUiSlider({start:[100],step:1,connect:"lower",range:{min:0,max:100}});$("#cloudCoverSlider").on("slide",setCloud);$("#cloudCoverSlider").on("set",updateCloud);$(".cloudValues").html('<i class="fa fa-cloud"></i> '+scope.cloudmin+" - "+scope.cloudmax+" %");$("#dateSlider").noUiSlider({range:{min:scope.datestart.unix(),max:scope.dateend.unix()},behaviour:"drag",connect:true,step:1*24*60*60,format:wNumb({decimals:0}),start:[moment(scope.datestart).unix(),moment(scope.dateend).unix()]});$(".dateValues").html(scope.datestart.format("MMM DD, YYYY")+" - "+scope.dateend.format("MMM DD, YYYY"));$("#dateSlider").on("slide",setDate);$("#dateSlider").on("set",updateDate)}$(document).ready(function(){initFilters();$("#modalAbout").modal()});
