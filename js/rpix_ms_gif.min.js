var scope={overlay:"VIIRS_SNPP_CorrectedReflectance_TrueColor",date:"",uuid:"",size:"m"},descr_basemap={VIIRS_SNPP_CorrectedReflectance_TrueColor:"VIIRS True Color","VIIRS_SNPP_CorrectedReflectance_BandsM11-I2-I1":"VIIRS Bands M11-I2-I1","VIIRS_SNPP_CorrectedReflectance_BandsM3-I3-M11":"VIIRS Bands M3-I3-I11",MODIS_Terra_CorrectedReflectance_TrueColor:"Terra True Color",MODIS_Terra_CorrectedReflectance_Bands721:"Terra Bands 7-2-1",MODIS_Terra_CorrectedReflectance_Bands367:"Terra Bands 3-6-7",MODIS_Aqua_CorrectedReflectance_TrueColor:"Aqua True Color",MODIS_Aqua_CorrectedReflectance_Bands721:"Aqua Bands 7-2-1"},map=new mapboxgl.Map({container:"map",center:[0,0],attributionControl:true,zoom:1,minZoom:0,maxZoom:8});map.addControl(new mapboxgl.Navigation({position:"top-left"}));function generateUUID(){var b=new Date().getTime();var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(b+Math.random()*16)%16|0;b=Math.floor(b/16);return(e=="x"?d:(d&3|8)).toString(16)});return a}function mapResize(){var a=$(".map").height()/-2,d=($(".map-area").height()-100)/$(".map").height(),b=$(".map-area").width();if(d>=1){d=1}if($(".map").width()*d>b-50){d=(b-50)/$(".map").width();if(d>=1){d=1}}var c=$(".map").width()/-2;$(".map").css({transform:"scale("+d+")",margin:a+"px 0 0 "+c+"px"})}window.onresize=function(){mapResize()};function setSize(a){["#s-size","#m-size","#l-size"].forEach(function(b){$(b).removeClass("on")});["s","l","m"].forEach(function(b){$(".map").removeClass(b)});switch(a){case"s":$("#s-size").addClass("on");$(".map").addClass("s");break;case"m":$("#m-size").addClass("on");$(".map").addClass("m");break;case"l":$("#l-size").addClass("on");$(".map").addClass("l");break;case null:break}scope.size=a;window.dispatchEvent(new Event("resize"));mapResize()}function getStyle(a,b){$(".legend span").text("Basemap: "+descr_basemap[b]);var d="https://map1.vis.earthdata.nasa.gov/wmts-webmerc/"+b+"/default/"+a+"/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",c={version:8,sources:{"gibs-tiles":{type:"raster",tiles:[d],attribution:['<a href="https://remotepixel.ca">&copy; RemotePixel.ca</a> ',' <a href="http://mapbox.com">Mapbox</a> ',' <a href="http://openstreetmap.com">OpenStreetMap</a> ',' <a href="https://earthdata.nasa.gov/about/science-system-description/eosdis-components/global-imagery-browse-services-gibs" >NASA EOSDIS GIBS</a>'],tileSize:256}},layers:[{id:"gibs-tiles",type:"raster",source:"gibs-tiles",minZoom:1,maxZoom:8}]};if(document.getElementById("coastline-checkbox").checked){c.sources.coast={type:"raster",tiles:["https://map1.vis.earthdata.nasa.gov/wmts-webmerc/Reference_Features/default/0/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",],tileSize:256};c.layers.push({id:"coast",type:"raster",source:"coast",minZoom:1,maxZoom:8})}if(document.getElementById("place-checkbox").checked){c.sources.places={type:"raster",tiles:["https://map1.vis.earthdata.nasa.gov/wmts-webmerc/Reference_Labels/default/0/GoogleMapsCompatible_Level9/{z}/{y}/{x}.png",],tileSize:256};c.layers.push({id:"places",type:"raster",source:"places",minZoom:1,maxZoom:8})}return c}function addDates(a){reset();var c=moment.utc().subtract(1,"days").format("YYYY-MM-DD"),b=[scope.date];switch(a){case"7":for(i=1;i<7;i++){b.push(moment.utc(scope.date).subtract(i,"days").format("YYYY-MM-DD"))}break;case"15":for(i=1;i<15;i++){b.push(moment.utc(scope.date).subtract(i,"days").format("YYYY-MM-DD"))}break;case"25":for(i=1;i<25;i++){b.push(moment.utc(scope.date).subtract(i,"days").format("YYYY-MM-DD"))}break;case"1/6":for(i=1;i<6;i++){b.push(moment.utc(scope.date).subtract(i,"months").format("YYYY-MM-DD"))}break;case"1/12":for(i=1;i<12;i++){b.push(moment.utc(scope.date).subtract(i,"months").format("YYYY-MM-DD"))}break;case"1/24":for(i=1;i<24;i++){b.push(moment.utc(scope.date).subtract(i,"months").format("YYYY-MM-DD"))}break;case null:break}b.forEach(function(d){scope.date=d;if(moment(scope.date).isBefore("2015-11-24")){if(scope.overlay=="VIIRS_SNPP_CorrectedReflectance_TrueColor"){scope.overlay="MODIS_Terra_CorrectedReflectance_TrueColor"}if(scope.overlay=="VIIRS_SNPP_CorrectedReflectance_BandsM11-I2-I1"){scope.overlay="MODIS_Terra_CorrectedReflectance_Bands721"}if(scope.overlay=="VIIRS_SNPP_CorrectedReflectance_BandsM3-I3-M11"){scope.overlay="MODIS_Terra_CorrectedReflectance_Bands367"}}addImgToList()})}function changeOverlay(b,a){map.setStyle(getStyle(a,b))}function updateOverlay(a){scope.overlay=a;map.setStyle(getStyle(scope.date,a))}function back(){$(".tab-selector-1").prop("checked",true)}function reset(){$(".list-img").empty();scope.selected_img=[];$(".tab-selector-2").attr("disabled","disabled");$("#sort-btn").addClass("display-none");$("#reset-btn").addClass("display-none")}function sortImagesDown(d,c){return moment(c.getAttribute("data-date"))-moment(d.getAttribute("data-date"))}function sortImagesUp(d,c){return moment(d.getAttribute("data-date"))-moment(c.getAttribute("data-date"))}function sort(){var a=$(".list-img").children();$(".list-img").empty();if($("#sort-arrow").hasClass("fa-long-arrow-up")){$("#sort-arrow").removeClass("fa-long-arrow-up");$("#sort-arrow").addClass("fa-long-arrow-down");(a).sort(sortImagesUp)}else{$("#sort-arrow").removeClass("fa-long-arrow-down");$("#sort-arrow").addClass("fa-long-arrow-up");(a).sort(sortImagesDown)}$(".list-img").append(a)}function showImg(b){var a=b.parentNode;scope.overlay=a.getAttribute("data-layer");$(".date-button").datepicker("setDate",a.getAttribute("data-date"))}function removeImg(a){$(a).parent().remove();if($(".list-img").children().length>1){$(".tab-selector-2").prop("disabled",false);$("#sort-btn").removeClass("display-none")}else{$(".tab-selector-2").attr("disabled","disabled");$("#sort-btn").addClass("display-none")}if($(".list-img").children().length>0){$("#reset-btn").removeClass("display-none")}else{$("#reset-btn").addClass("display-none")}}function addImgToList(){switch(scope.overlay){case"VIIRS_SNPP_CorrectedReflectance_TrueColor":var a='<span class="sat left-block green">V</span>';break;case"VIIRS_SNPP_CorrectedReflectance_BandsM11-I2-I1":var a='<span class="sat left-block blue">V</span>';break;case"VIIRS_SNPP_CorrectedReflectance_BandsM3-I3-M11":var a='<span class="sat left-block orange">V</span>';break;case"MODIS_Terra_CorrectedReflectance_TrueColor":var a='<span class="sat left-block green">T</span>';break;case"MODIS_Terra_CorrectedReflectance_Bands721":var a='<span class="sat left-block blue">T</span>';break;case"MODIS_Terra_CorrectedReflectance_Bands367":var a='<span class="sat left-block orange">T</span>';break;case"MODIS_Aqua_CorrectedReflectance_TrueColor":var a='<span class="sat left-block green">A</span>';break;case"MODIS_Aqua_CorrectedReflectance_Bands721":var a='<span class="sat left-block blue">A</span>';break;case null:break}$(".list-img").append('<div class="list-element" data-date="'+scope.date+'" data-layer="'+scope.overlay+'"> '+a+'<span class="center-block">'+scope.date+'</span><button onclick="showImg(this)" class="rm-btn right-block"><i class="fa fa-eye"></i></button><button onclick="removeImg(this)" class="rm-btn right-block"><i class="fa fa-trash-o"></i></button></div> ');if($(".list-img").children().length>1){$(".tab-selector-2").prop("disabled",false);$("#sort-btn").removeClass("display-none")}else{$(".tab-selector-2").attr("disabled","disabled");$("#sort-btn").addClass("display-none")}if($(".list-img").children().length>0){$("#reset-btn").removeClass("display-none")}else{$("#reset-btn").addClass("display-none")}}$("#coastline-checkbox").change(function(){if(this.checked){$("#coastline-checkbox").parent().addClass("slider-white")}else{$("#coastline-checkbox").parent().removeClass("slider-white")}changeOverlay(scope.overlay,scope.date)});$("#place-checkbox").change(function(){if(this.checked){$("#place-checkbox").parent().addClass("slider-white")}else{$("#place-checkbox").parent().removeClass("slider-white")}changeOverlay(scope.overlay,scope.date)});$(".tab-selector-2").change(function(){if(this.checked){scope.uuid=generateUUID()}else{scope.uuid=""}$(".form-rq").removeClass("display-none");$(".form-rq-resp").addClass("display-none");$(".uuid-text").text("Task ID: "+scope.uuid)});$("#submit-request").validator().on("valid.bs.validator",function(){$("#sendGIFrequest").removeClass("disabled")}).on("invalid.bs.validator",function(){$("#sendGIFrequest").addClass("disabled")});$("#sendGIFrequest").on("click",function(h){if(!$("#sendGIFrequest").hasClass("disabled")){var g=map.getBounds(),c=g._sw.lng.toString()+","+g._sw.lat.toString()+","+g._ne.lng.toString()+","+g._ne.lat.toString();var f={uuid:scope.uuid,size:scope.size,aoi:c,dates:[],overlays:[],mailto:$("#EmailRequest").val(),rot:map.getBearing(),places:document.getElementById("place-checkbox").checked.toString(),borders:document.getElementById("coastline-checkbox").checked.toString(),};var b=document.getElementsByClassName("list-img")[0].children,d;for(d=0;d<b.length;d++){f.dates.push(b[d].getAttribute("data-date"));f.overlays.push(b[d].getAttribute("data-layer"))}var a=$.post("{{ RPIX_API }}/modisgif",JSON.stringify({info:f}));$(".form-rq").addClass("display-none");$(".form-rq-resp").removeClass("display-none");$(".form-rq").find("form")[0].reset()}});$(document).ready(function(){$(".date-button").datepicker({format:"yyyy-mm-dd",autoclose:true,todayHighlight:true,startDate:"2012-05-08",endDate:moment.utc().format("YYYY-MM-DD")}).on("changeDate",function(b){scope.date=moment(b.date).format("YYYY-MM-DD");$(".date-button").text(scope.date);if(moment(scope.date).isBefore("2015-11-24")){if(scope.overlay=="VIIRS_SNPP_CorrectedReflectance_TrueColor"){scope.overlay="MODIS_Terra_CorrectedReflectance_TrueColor"}if(scope.overlay=="VIIRS_SNPP_CorrectedReflectance_BandsM11-I2-I1"){scope.overlay="MODIS_Terra_CorrectedReflectance_Bands721"}if(scope.overlay=="VIIRS_SNPP_CorrectedReflectance_BandsM3-I3-M11"){scope.overlay="MODIS_Terra_CorrectedReflectance_Bands367"}$(".dropdown-menu .viirs").addClass("not-active")}else{$(".dropdown-menu .viirs").removeClass("not-active")}changeOverlay(scope.overlay,scope.date)});$(".date-button").datepicker("setDate",moment.utc().subtract(1,"days").format("YYYY-MM-DD"));var a=window.location.href;$("#twitter").attr("href","https://twitter.com/share?url="+encodeURIComponent(a)+"&via=RemotePixel&hashtags=MODIS&related=NASAEarthData&text=MODIS-VIIRS GIF Creation");$("#linkedin").attr("href","https://www.linkedin.com/shareArticle?mini=true&url="+encodeURIComponent(a)+"&title=MODIS-VIIRS GIF Creation&source=https://remotepixel.ca");$("#facebook").attr("href","https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(a));mapResize()});
