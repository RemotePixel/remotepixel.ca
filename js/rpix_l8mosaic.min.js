function timestamp(a){return new Date(a).getTime()}function mod(b,a){return((b%a)+a)%a}function sortNumber(d,c){return d-c}function sortScenesDate(d,c){return Date.parse(c.acquisitionDate)-Date.parse(d.acquisitionDate)}function isInArray(b,a){return(b.indexOf(a)>=0)?true:false}function generateUUID(){var b=new Date().getTime();var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(b+Math.random()*16)%16|0;b=Math.floor(b/16);return(e=="x"?d:(d&3|8)).toString(16)});return a}$("#submit-request").validator().on("valid.bs.validator",function(){$("#sendMosaicrequest").removeClass("disabled")}).on("invalid.bs.validator",function(){$("#sendMosaicrequest").addClass("disabled")});$("#sendMosaicrequest").on("click",function(c){if(!$("#sendMosaicrequest").hasClass("disabled")){var a=[];imOverlayGr.eachLayer(function(e){a.push(e.options.id)});var b={uuid:scope._uuid,bands:$("#band-combination input[name='combination']:checked").attr("data"),mailto:$("#EmailRequest").val(),image_list:"["+a+"]"};var d=$.post("{{ RPIX_API }}/landsat/mosaic",JSON.stringify({info:b}));$("#myModal").modal("hide");$("#myModal").on("hidden.bs.modal",function(){$(this).find("form")[0].reset()});$("#titleAPI").text("Success");$("#modalAPI").modal()}});function initFilters(){$("#cloudCoverSlider").noUiSlider({start:[0,20],step:1,behaviour:"drag",connect:true,range:{min:0,max:100}});$("#cloudCoverSlider").noUiSlider_pips({mode:"positions",values:[0,25,50,75,100],density:4});$("#cloudCoverSlider").on("slide",setCloud);$("#cloudCoverSlider").on("set",updateCloud);$("#dateSlider").noUiSlider({range:{min:timestamp(scope.filtervalues.datestart),max:timestamp(scope.filtervalues.dateend)},connect:true,step:1*24*60*60*1000,format:wNumb({decimals:0}),start:[timestamp(scope.filtervalues.datestart),timestamp(scope.filtervalues.dateend)]});var b=Date.parse(scope.filtervalues.dateend)-Date.parse(scope.filtervalues.datestart),a=[Date.parse(scope.filtervalues.datestart),Date.parse(scope.filtervalues.datestart)+b/4,Date.parse(scope.filtervalues.datestart)+2*b/4,Date.parse(scope.filtervalues.datestart)+3*b/4,Date.parse(scope.filtervalues.dateend)];$("#dateSlider").noUiSlider_pips({mode:"values",values:a,density:4,stepped:true});$("#dateSlider > .noUi-pips > .noUi-value").each(function(){$(this).html(new Date(Number($(this).html())).toISOString().slice(0,7))});$("#dateSlider").on("slide",setDate);$("#dateSlider").on("set",updateDate);$("#seasonSlider").noUiSlider({range:{min:0,max:4},margin:1,behaviour:"drag",connect:true,step:1,format:wNumb({decimals:0}),start:[0,4]});$("#seasonSlider").noUiSlider_pips({mode:"values",density:11,values:[0.5,1.5,2.5,3.5]});$("#seasonSlider > .noUi-pips > .noUi-value").each(function(){var c=["spring","summer","autumn","winter"];$(this).html(c[$(this).html()-1])});$("#seasonSlider").on("set",updateSeason);$("#cloud-filter").html('<i class="fa fa-cloud fa-2x"><hbut> : '+scope.filtervalues.cloudmin+"% - "+scope.filtervalues.cloudmax+"%</hbut></i>");$("#date-filter").html('<i class="fa fa-calendar-o fa-2x"><hbut> : '+scope.filtervalues.datestart+" - "+scope.filtervalues.dateend+"</hbut></i>")}function resetFilters(){scope.filtervalues.cloudmin=0;scope.filtervalues.cloudmax=20;scope.filtervalues.datestart=new Date("2013-04-01").toISOString().slice(0,10);scope.filtervalues.dateend=new Date().toISOString().slice(0,10);scope.filtervalues.seasons=["spring","summer","autumn","winter"];$("#cloudCoverSlider").val([scope.filtervalues.cloudmin,scope.filtervalues.cloudmax]);var a=Date.parse(scope.filtervalues.dateend)-Date.parse(scope.filtervalues.datestart);$("#dateSlider").val([Date.parse(scope.filtervalues.datestart),Date.parse(scope.filtervalues.dateend)]);$("#seasonSlider").val([0,4]);$("#cloud-filter").html('<i class="fa fa-cloud fa-2x"><hbut> : '+scope.filtervalues.cloudmin+"% - "+scope.filtervalues.cloudmax+"%</hbut></i>");$("#date-filter").html('<i class="fa fa-calendar-o fa-2x"><hbut> : '+scope.filtervalues.datestart+" - "+scope.filtervalues.dateend+"</hbut></i>")}function setCloud(){scope.filtervalues.cloudmin=parseInt($("#cloudCoverSlider").val()[0]);scope.filtervalues.cloudmax=parseInt($("#cloudCoverSlider").val()[1]);$("#cloud-filter").html('<i class="fa fa-cloud fa-2x"><hbut> : '+scope.filtervalues.cloudmin+"% - "+scope.filtervalues.cloudmax+"%</hbut></i>")}function updateCloud(){scope.filtervalues.cloudmin=parseInt($("#cloudCoverSlider").val()[0]);scope.filtervalues.cloudmax=parseInt($("#cloudCoverSlider").val()[1]);$("#cloud-filter").html('<i class="fa fa-cloud fa-2x"><hbut> : '+scope.filtervalues.cloudmin+"% - "+scope.filtervalues.cloudmax+"%</hbut></i>");landsatQuery(scope.aoiBounds)}function setDate(){scope.filtervalues.datestart=new Date(Number($("#dateSlider").val()[0])).toISOString().slice(0,10);scope.filtervalues.dateend=new Date(Number($("#dateSlider").val()[1])).toISOString().slice(0,10);$("#date-filter").html('<i class="fa fa-calendar-o fa-2x"><hbut> : '+scope.filtervalues.datestart+" - "+scope.filtervalues.dateend+"</hbut></i>")}function updateDate(){scope.filtervalues.datestart=new Date(Number($("#dateSlider").val()[0])).toISOString().slice(0,10);scope.filtervalues.dateend=new Date(Number($("#dateSlider").val()[1])).toISOString().slice(0,10);$("#date-filter").html('<i class="fa fa-calendar-o fa-2x"><hbut> : '+scope.filtervalues.datestart+" - "+scope.filtervalues.dateend+"</hbut></i>");landsatQuery(scope.aoiBounds)}function updateSeason(){var a=["spring","summer","autumn","winter"];scope.filtervalues.seasons=a.slice($("#seasonSlider").val()[0],$("#seasonSlider").val()[1]);landsatQuery(scope.aoiBounds)}function toggleOpenFilter(a){switch(a){case"date":$("div.date-filter").toggleClass("display-none");$("div.cloud-filter").addClass("display-none");$("div.season-filter").addClass("display-none");break;case"cloud":$("div.cloud-filter").toggleClass("display-none");$("div.date-filter").addClass("display-none");$("div.season-filter").addClass("display-none");break;case"season":$("div.season-filter").toggleClass("display-none");$("div.cloud-filter").addClass("display-none");$("div.date-filter").addClass("display-none");break;case null:break}}function closeleftpane(){$("#left-pane").addClass("display-none");$("#landsat-wall").empty();$("#landsat-wall").scrollTop(0);map.invalidateSize()}function clearall(){imOverlayGr.clearLayers();$("#show-all").removeClass("display-none");$("#clear-all").addClass("display-none");$("#complete-all").addClass("display-none");$("#left-pane").addClass("display-none");$("#landsat-wall").empty();$("#landsat-wall").scrollTop(0);map.invalidateSize()}function imOverlayBuilt(e){var c=turf.polygon([[[e.upperLeftCornerLongitude,e.upperLeftCornerLatitude],[e.upperRightCornerLongitude,e.upperRightCornerLatitude],[e.lowerRightCornerLongitude,e.lowerRightCornerLatitude],[e.lowerLeftCornerLongitude,e.lowerLeftCornerLatitude],[e.upperLeftCornerLongitude,e.upperLeftCornerLatitude]]]);var f=turf.extent(c);var d=[[f[3],f[0]],[f[3],f[2]],[f[1],f[2]],[f[1],f[0]]];var b=[[e.upperLeftCornerLatitude,e.upperLeftCornerLongitude],[e.upperRightCornerLatitude,e.upperRightCornerLongitude],[e.lowerRightCornerLatitude,e.lowerRightCornerLongitude],[e.lowerLeftCornerLatitude,e.lowerLeftCornerLongitude],[e.upperLeftCornerLatitude,e.upperLeftCornerLongitude]];var a={attribution:"&copy Landsat imagery courtesy of NASA and USGS",id:e.sceneID,rp:e.rowpath,info:{date:e.date,cloud:e.cloud},clip:b};return new L.ImageTransform(e.browseURL,d,a)}function complete(){var c=[];imOverlayGr.eachLayer(function(e){c.push(e.options.rp)});map.spin(true);var a=Object.keys(footprintGr._layers);for(var b=0;b<a.length;b++){var d=footprintGr._layers[a[b]];if(isInArray(c,d.id)){continue}scope.allscenes=d.scenes;scope.allscenes.sort(sortScenesDate);imOverlayGr.addLayer(imOverlayBuilt(scope.allscenes[0]))}imOverlayGr.eachLayer(function(e){e._image.onclick=function(){if(map.dragging.moved()){return}imChange(e)}});$("#show-all").addClass("display-none");$("#clear-all").removeClass("display-none");map.spin(false)}function showall(){map.spin(true);imOverlayGr.clearLayers();var a=Object.keys(footprintGr._layers);for(var b=0;b<a.length;b++){var c=footprintGr._layers[a[b]];scope.allscenes=c.scenes;scope.allscenes.sort(sortScenesDate);imOverlayGr.addLayer(imOverlayBuilt(scope.allscenes[0]))}imOverlayGr.eachLayer(function(d){d._image.onclick=function(){if(map.dragging.moved()){return}imChange(d)}});$("#show-all").addClass("display-none");$("#clear-all").removeClass("display-none");map.spin(false)}function imgclick(a){imOverlayGr.eachLayer(function(b){if(b.options.rp==scope.allscenes[a].rowpath){imOverlayGr.removeLayer(b)}});imOverlayGr.addLayer(imOverlayBuilt(scope.allscenes[a]));$("#complete-all").removeClass("display-none");imOverlayGr.eachLayer(function(b){b._image.onclick=function(){if(map.dragging.moved()){return}imChange(b)}})}function imChange(a){imOverlayGr.removeLayer(a);$("#left-pane").removeClass("display-none");$("#landsat-wall").empty();$("#landsat-wall").scrollTop(0);map.invalidateSize();map.spin(true);var c=a.options.rp;var d={};footprintGr.eachLayer(function(e){d[e.id]=e});scope.allscenes=d[c].scenes;scope.allscenes.sort(sortScenesDate);browse=[];for(var b=0;b<scope.allscenes.length;b++){browse.push('<div class="result-content"><img id="'+scope.allscenes[b].sceneID+'" class="img-thumb"data-sizes="auto" src="'+scope.allscenes[b].browseURL+'" onclick="imgclick('+b+')"><div class="result-overlay"><div><i class="fa fa-calendar-o"></i><span>  '+scope.allscenes[b].acquisitionDate+'</span></div><div><i class="fa fa-cloud"></i><span>  '+scope.allscenes[b].cloudCoverFull+" %</span></div></div></div>")}$("#landsat-wall").append(browse);map.spin(false);$("#show-all").addClass("display-none");$("#clear-all").removeClass("display-none");$("#complete-all").removeClass("display-none")}function resetmap(){editableLayers.clearLayers();footprintGr.clearLayers();imOverlayGr.clearLayers();scope.aoiBounds=undefined;$("#left-pane").addClass("display-none");$("#landsat-wall").empty();$("#landsat-wall").scrollTop(0);map.invalidateSize();$("#show-all").addClass("display-none");$("#clear-all").addClass("display-none");$("#complete-all").addClass("display-none")}function cleanmap(){footprintGr.clearLayers();imOverlayGr.clearLayers();$("#left-pane").addClass("display-none");$("#landsat-wall").empty();$("#landsat-wall").scrollTop(0);map.invalidateSize();$("#show-all").addClass("display-none");$("#clear-all").addClass("display-none");$("#complete-all").addClass("display-none")}function onClickRowPath(){$("#left-pane").removeClass("display-none");$("#landsat-wall").empty();$("#landsat-wall").scrollTop(0);this.bringToBack();map.invalidateSize();map.spin(true);scope.allscenes=this.scenes;scope.allscenes.sort(sortScenesDate);browse=[];for(var a=0;a<scope.allscenes.length;a++){browse.push('<div class="result-content"><img id="'+scope.allscenes[a].sceneID+'" class="img-thumb"data-sizes="auto" src="'+scope.allscenes[a].browseURL+'" onclick="imgclick('+a+')"><div class="result-overlay"><div><i class="fa fa-calendar-o"></i><span>  '+scope.allscenes[a].acquisitionDate+'</span></div><div><i class="fa fa-cloud"></i><span>  '+scope.allscenes[a].cloudCoverFull+" %</span></div></div></div>")}$("#landsat-wall").append(browse);map.spin(false);$("#show-all").addClass("display-none");$("#clear-all").removeClass("display-none");$("#complete-all").removeClass("display-none")}function getSeason(i,e){var b=moment(i,"YYYY-MM-DD"),j=b.dayOfYear(),f=b.year(),k=moment({year:f,month:2,day:21}).dayOfYear(),d=moment({year:f,month:5,day:21}).dayOfYear(),a=moment({year:f,month:8,day:22}).dayOfYear(),h=moment({year:f,month:11,day:21}).dayOfYear(),c=["spring","summer","autumn","winter"];if(e<0){c.reverse()}var g="";if(j<k||j>=h){g=c[3]}if(j>=k&&j<d){g=c[0]}if(j>=d&&j<a){g=c[1]}if(j>=a&&j<h){g=c[2]}return g}function getDataAndUpdate(b){map.spin(true);cleanmap();var d=Object.keys(editableLayers._layers),c=editableLayers._layers[d[0]].getBounds();var a={};$.getJSON(b,function(v){var w=v.info.results.total;if(w<2000){for(var r=0;r<v.results.length;r++){var u={};u.rowpath=v.results[r].row+"-"+v.results[r].path;u.sceneStartTime=moment(v.results[r].sceneStartTime,["YYYY-MM-DD HH:mm:ss.S","YYYY:DDD:HH:mm:ss"]).toDate();u.sceneStopTime=moment(v.results[r].sceneStopTime,["YYYY-MM-DD HH:mm:ss.S","YYYY:DDD:HH:mm:ss"]).toDate();u.acquisitionDate=v.results[r].acquisitionDate;u.browseAvailable=v.results[r].browseAvailable;u.lat=v.results[r].sceneCenterLatitude;u.lon=v.results[r].sceneCenterLongitude;if(u.lon>0){u.lon=u.lon+Math.floor((c._southWest.lng+180)/360)*360}else{u.lon=u.lon+Math.floor((c._northEast.lng+180)/360)*360}u.browseURL=v.results[r].browseURL;u.cloudCover=v.results[r].cloudCover;u.cloudCoverFull=v.results[r].cloudCoverFull;u.dayOrNight=v.results[r].dayOrNight;u.path=v.results[r].path;u.row=v.results[r].row;u.sceneID=v.results[r].sceneID;u.lowerLeftCornerLatitude=v.results[r].lowerLeftCornerLatitude;u.lowerRightCornerLatitude=v.results[r].lowerRightCornerLatitude;u.upperLeftCornerLatitude=v.results[r].upperLeftCornerLatitude;u.upperRightCornerLatitude=v.results[r].upperRightCornerLatitude;u.lowerLeftCornerLongitude=v.results[r].lowerLeftCornerLongitude;u.lowerRightCornerLongitude=v.results[r].lowerRightCornerLongitude;u.upperLeftCornerLongitude=v.results[r].upperLeftCornerLongitude;u.upperRightCornerLongitude=v.results[r].upperRightCornerLongitude;u.S3=(v.results[r].hasOwnProperty("S3"))?true:false;var n=Math.abs(u.lowerLeftCornerLongitude-u.lowerRightCornerLongitude),f=Math.abs(u.upperLeftCornerLongitude-u.upperRightCornerLongitude);if((n>180)||(f>180)){if(u.lowerLeftCornerLongitude<0){u.lowerLeftCornerLongitude+=360}if(u.upperLeftCornerLongitude<0){u.upperLeftCornerLongitude+=360}if(u.lowerRightCornerLongitude<0){u.lowerRightCornerLongitude+=360}if(u.upperRightCornerLongitude<0){u.upperRightCornerLongitude+=360}}var h=["upperLeftCornerLongitude","upperRightCornerLongitude","lowerRightCornerLongitude","lowerLeftCornerLongitude"];for(var t=0;t<h.length;t++){adjustBound=(u[h[t]]>0)?"_southWest":"_northEast";u[h[t]]+=Math.floor((c[adjustBound].lng+180)/360)*360}u.season=getSeason(u.acquisitionDate,u.lat);if((u.S3==true)&&(u.browseAvailable=="Y")&&(u.dayOrNight=="DAY")&&isInArray(scope.filtervalues.seasons,u.season)){var p=u.rowpath;if(a.hasOwnProperty(p)){a[p].push(u)}else{a[p]=[];a[p].push(u)}}}}var s={color:"#000",weight:1.2,fill:true,fillOpacity:0,opacity:1};var j={color:"#2262CC",weight:3,opacity:0.6,fill:true,fillOpacity:0.65,fillColor:"#2262CC"};var q=Object.keys(a);for(var r=0;r<q.length;r++){var o=a[q[r]][0],k=L.latLng(o.lowerLeftCornerLatitude,o.lowerLeftCornerLongitude),e=L.latLng(o.lowerRightCornerLatitude,o.lowerRightCornerLongitude),m=L.latLng(o.upperLeftCornerLatitude,o.upperLeftCornerLongitude),g=L.latLng(o.upperRightCornerLatitude,o.upperRightCornerLongitude);var l=L.polygon([k,e,g,m],s).on("mouseover",function(){this.setStyle(j)}).on("mouseout",function(){this.setStyle(s)}).on("click",onClickRowPath);l.scenes=a[q[r]];l.id=q[r];footprintGr.addLayer(l)}if(q.length===0){$("div.h4noim").removeClass("display-none");$("#show-all").addClass("display-none")}else{map.fitBounds(footprintGr.getBounds());$("div.h4noim").addClass("display-none");$("#show-all").removeClass("display-none")}map.spin(false)}).fail(function(){$("div.h4noim").removeClass("display-none");map.spin(false)})}function landsatQuery(a){if(typeof a==="undefined"){return}var d=Math.floor((a._northEast.lng+180)/360)===Math.floor((a._southWest.lng+180)/360),j=[a._northEast.lat,a._southWest.lat],f=[mod(a._northEast.lng+180,360)-180,mod(a._southWest.lng+180,360)-180],k=j.sort(sortNumber)||["-90","90"],c="sceneCenterLatitude:["+k[0]+"+TO+"+k[1]+"]";if(d){var h=f.sort(sortNumber)||["-180","180"],e="+AND+sceneCenterLongitude:["+h[0]+"+TO+"+h[1]+"]"}else{var m=[-180,f.sort(sortNumber)[0]],l=[f.sort(sortNumber)[1],180],e="+AND+(sceneCenterLongitude:["+m[0]+"+TO+"+m[1]+"]+OR+sceneCenterLongitude:["+l[0]+"+TO+"+l[1]+"])"}var i="+AND+cloudCoverFull:["+scope.filtervalues.cloudmin+"+TO+"+scope.filtervalues.cloudmax+"]",b="+AND+acquisitionDate:["+scope.filtervalues.datestart+"+TO+"+scope.filtervalues.dateend+"]",g=scope.api_url+c+e+b+i+"&limit=2000";getDataAndUpdate(g)}function update_map_uuid(c){map.spin(true);var a="https://data.remotepixel.ca/mosaic/",b=a+c+".json",d=a+c+"_mosaic.tif";$.getJSON(b,function(i){var k={};k.coordinates=i.coordinates;k.id=i.id;var f=L.latLng(k.coordinates.south,k.coordinates.west),e=L.latLng(k.coordinates.north,k.coordinates.east),l=(((k.coordinates.east+180)+(k.coordinates.west+180))/2)-180,j=(((k.coordinates.north+90)+(k.coordinates.south+90))/2)-90,h='&copy Landsat imagery courtesy of NASA and USGS; <a href="https://remotepixel.ca/">RemotePixel</a>';var g=L.imageOverlay(d,L.latLngBounds(f,e),{attribution:h}).on("load",function(){map.spin(false)}).addTo(map);imOverlayGr.addLayer(g);map.fitBounds(g._bounds)}).fail(function(){map.spin(false)})}function getUrlVars(){var b={},a=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(c,d,e){b[d]=e});return b}var scope={aoiBounds:undefined,allscenes:[],api_url:"https://api.remotepixel.ca/landsat?search=",_uuid:"",filtervalues:{cloudmin:0,cloudmax:20,datestart:new Date("2013-04-01").toISOString().slice(0,10),dateend:new Date().toISOString().slice(0,10),seasons:["spring","summer","autumn","winter"]}};var map=L.map("map",{center:[0,0],bounceAtZoomLimits:false,worldCopyJump:false,zoomControl:false,minZoom:1,maxZoom:11});map.fitWorld();var osm_url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',OpenStreetMap=L.tileLayer(osm_url,{id:"MapID",attribution:attribution}).addTo(map);L.control.zoom({position:"topright"}).addTo(map);var imOverlayGr=new L.layerGroup().addTo(map),footprintGr=new L.featureGroup().addTo(map);L.easyButton("fa-info",function(){$("#modalAbout").modal()},"About");L.easyButton("fa-share",function(){var a="https://remotepixel.ca/projects/landsat8mosaic.html";$("#twitter").attr("href","https://twitter.com/share?text=Create Your Own Landsat 8 Mosaic&url="+a+"&via=RemotePixel&hashtags=Landsat&via=RemotePixel");$("#linkedin").attr("href","https://www.linkedin.com/shareArticle?mini=true&url="+a+"&title="+document.title+"&source=https://remotepixel.ca");$("#facebook").attr("href","https://www.facebook.com/sharer/sharer.php?u="+a);$("#modalShare-bottom").modal()},"Share it");L.easyButton("fa-file-text-o",function(){_ids=[];imOverlayGr.eachLayer(function(a){_ids.push(a.options.id)});if(_ids.length!=0){$("#title-ids").text("Landsat IDs");$("#corps-ids").html('<pre style="word-wrap: break-word; white-space: pre-wrap;">'+JSON.stringify(_ids,null,4)+"</pre>");$("#modalIDs").modal()}},"Get Landsat IDs");L.easyButton("fa-file-image-o",function(){var a=imOverlayGr.getLayers();if(a.length!=0){scope._uuid=generateUUID();$("#myModalLabel").text("Mosaic Creation (RemotePixel API)");$("#uuid-text").text("Task ID: "+scope._uuid);$("#myModal").modal()}},"mosaic Creation");L.easyButton("fa-home",function(){resetmap();resetFilters();map.fitWorld()},"Reset");var editableLayers=new L.FeatureGroup();map.addLayer(editableLayers);var options={position:"topright",draw:{polyline:false,polygon:false,circle:false,rectangle:{shapeOptions:{clickable:false,color:"#000",weight:1,fill:false,dashArray:[5,5],opacity:1}},marker:false},edit:{featureGroup:editableLayers,remove:false}};var drawControl=new L.Control.Draw(options);map.addControl(drawControl);map.on("draw:created",function(c){var b=c.layerType,a=c.layer;editableLayers.clearLayers();editableLayers.addLayer(a);scope.aoiBounds=a.getBounds();landsatQuery(scope.aoiBounds)});map.on("draw:edited",function(c){var b=Object.keys(c.layers._layers);var a=c.layers._layers[b[0]];scope.aoiBounds=a.getBounds();landsatQuery(scope.aoiBounds)});$(document).ready(function(){initFilters();var a=getUrlVars();if(a.hasOwnProperty("uuid")){update_map_uuid(a.uuid)}else{$("#modalAbout").modal()}});
